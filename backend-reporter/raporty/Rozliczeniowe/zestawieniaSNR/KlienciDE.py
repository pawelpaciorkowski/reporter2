from dialog import Dialog, Panel, HBox, VBox, TextInput, LabSelector, TabbedView, Tab, InfoText, DateInput, \
    Radio, ValidationError, Switch
from helpers.validators import validate_date_range
from tasks import TaskGroup, Task
from outlib.xlsx import ReportXlsx
from helpers import prepare_for_json
from datasources.snr import SNR
import base64
import datetime

MENU_ENTRY = 'Klienci D, E'

NIPY = [
    '5541694809', '5542933883', '5611326590', '8751187813', '8792676503', '9531697174', '9670087350', '9671206319',
    '9671429255', '5541090951', '5542274995', '5542412138', '5542526422', '5542709051', '5542831473', '5542833414',
    '5542942876', '5542954477', '5552123329', '5561100032', '5561256188', '5571073294', '5571346668', '5591042629',
    '5591299647', '5611018374', '5611326271', '5611326578', '5611356823', '5611454081', '5611457027', '7393312762',
    '8791309837', '8792060156', '8891176755', '8971812331', '9291710879', '9532293970', '9532558552', '9561523289',
    '9562306803', '9671053502', '9671330338', '5471761675', '6312259366', '6312539864', '6312658474', '6341087494',
    '6341262595', '6342438955', '6342642696', '6342857540', '6391800155', '6421255829', '6422585351', '6422702816',
    '6422946487', '6462593718', '6471027131', '6471120994', '6471608307', '6471642445', '6471801263', '6471848431',
    '6472099842', '6472209578', '6472236919', '6472247231', '6472251451', '6472581757', '6472587837', '7382090217',
    '9541201795', '9541900205', '9691170978', '6271669698', '9491452287', '5731068624', '5732560600', '5732852490',
    '5771418007', '6261280332', '6262917027', '6263013428', '6272731459', '6291707930', '6431615815', '6482335617',
    '6492147834', '9491921931', '9492145558', '6551021768', '6571026504', '6581708139', '6570007692', '6571037034',
    '6572951886', '6621128395', '9590909867', '9591773789', '5990112202', '5992340605', '5992340640', '5992446433',
    '5992973960', '5992988950', '5993260050', '7010703126', '8512959483', '5991081478', '5991115289', '5991143593',
    '5991169612', '5991183500', '5991329085', '5991386120', '5991537895', '5991702012', '5991804379', '5991822265',
    '5992333203', '5993162726', '6191800469', '6221890716', '6691905272', '6842110324', '6871848481', '6931809706',
    '8241157842', '6762416771', '6762454576', '6762568914', '6772161462', '6793087334', '7351090883', '7561746686',
    '5130260328', '5422048351', '6762119174', '6762162750', '6762266685', '6762333950', '6762438270', '6762514930',
    '6782853606', '6782876866', '6783125814', '6792886263', '6793128085', '6793194283', '6811087914', '6811216872',
    '6811219505', '6811706694', '6811732384', '6831094136', '7351489042', '7361011224', '7371283970', '7371318119',
    '7371796600', '7532230081', '7541242149', '7541484734', '7561768877', '8641836937', '8971758910', '9451531483',
    '9452096084', '9452184960', '6841507516', '6842246839', '6871079775', '6871174290', '6871234709', '6871258348',
    '6871302931', '6881004968', '6881025108', '6881049965', '6891005372', '6891054212', '6891062393', '6891069857',
    '7311361991', '7931268820', '7952145755', '7952177063', '6121303530', '6861658684', '6871081306', '6871129148',
    '6871584160', '6881112741', '6881221743', '6891002681', '6891005389', '6891006118', '6891006472', '6891034882',
    '6891050390', '6891069573', '6891224714', '7341335840', '7341810063', '7341864366', '7342716633', '7342890331',
    '7343515285', '7343529413', '7343599773', '7951055091', '7951101282', '7951696803', '7952529355', '7952550510',
    '8133693472', '8631579858', '8711536472', '8733054378', '8733116487', '9552065456', '5130183585', '5492450354',
    '6751346529', '6783186773', '9451929731', '5130189659', '5250005739', '6371667747', '6371878869', '6372193659',
    '6591331699', '6751520430', '67652404756', '6772299255', '6772375186', '6782026777', '6782034825', '6782732541',
    '6782908885', '6783049970', '6791038596', '6791300893', '5070067609', '7251022847', '7251672864', '7261369251',
    '7261718237', '7262595676', '7271515470', '7272670221', '7311341221', '7311871083', '7321220654', '7731438625',
    '8881741372', '9471511696', '5651010692', '6581931162', '7251051731', '7251679151', '7252261821', '7260000561',
    '7261153717', '7261656192', '7262250948', '7262660451', '7262674602', '7271680306', '7271886290', '7272546403',
    '7272547785', '7272581523', '7272834898', '7282674226', '7292633447', '7311986828', '7312033361', '7322174264',
    '7691040890', '7691052019', '7731684146', '9471807876', '9471863455', '9471985537', '5391062395', '7121966001',
    '7123222374', '5371470211', '5371979707', '5372234441', '5381028333', '5391007315', '5391011216', '5391062159',
    '5391137928', '5391331866', '5391397291', '5391493942', '5631770359', '7120318961', '7121070374', '7121109113',
    '7122328550', '7122498097', '7122641577', '7122678238', '7122686568', '7122691693', '7122770671', '7122881258',
    '7123230592', '7123411201', '7141084882', '7141286829', '7141761130', '7141772027', '7141925092', '7141929368',
    '7141991060', '7142056830', '7161292773', '7171627229', '7171805406', '7171812398', '8621447167', '9461421721',
    '9461836221', '9462424058', '9462622893', '9462652084', '9462689874', '5631063449', '5631472490', '5631950877',
    '5641034900', '5641795668', '7121341790', '7122510289', '7122609680', '7123320993', '7132367215', '7151034791',
    '7151106929', '7151655530', '7151939859', '9462309972', '5631124518', '5631142203', '5631145288', '5631297437',
    '5631389116', '5631983919', '5632041444', '5632081952', '5632421767', '5641136606', '5641213761', '5641256084',
    '5641276336', '7121056718', '7122512992', '7122586424', '7122684919', '7123119966', '7123363169', '7131272079',
    '7131279199', '7132367304', '7151193354', '7151587679', '7151655582', '8821921426', '9182070116', '9461019427',
    '9462256282', '9462657437', '5110289501', '8133351493', '8921487389', '9840209770', '5110108149', '5110203600',
    '5691083993', '5691246716', '5691299262', '6181229458', '7451042151', '7451299996', '8741577375', '8771127607',
    '8941810764', '7281247077', '7743214274', '7752650709', '7752667526', '8931037825', '5272926441', '5661055851',
    '5671029341', '5671169378', '5671170281', '5671173032', '5671209729', '5671674923', '5671906061', '6760102525',
    '7010644317', '7010945958', '7272710475', '7611556351', '7611556374', '7741123320', '7741211225', '7741768985',
    '7741942414', '7742351454', '7742477505', '7742800573', '7743185816', '7743211904', '7743222285', '7743231108',
    '7743253819', '7750001711', '7750005146', '7751125639', '7751280682', '7751515317', '7751518876', '7751522317',
    '7752149688', '7752316502', '7752453251', '7752587537', '7752647937', '7752648842', '7752662629', '7760000185',
    '7761029512', '7761116990', '7761237133', '7761624798', '8771450225', '8943079752', '9710162946', '9710541738',
    '5711162656', '7391183303', '7421007144', '8490006987', '5422667539', '5711014281', '5711110174', '5711302531',
    '6471727331', '7311291138', '7391044553', '7391167385', '7391222730', '7391375066', '7391657273', '7391947309',
    '7392019847', '7392120871', '7392134459', '7392185221', '7392219842', '7392278017', '7392286979', '7392899498',
    '7393033097', '7393043078', '7393044600', '7393338678', '7393804643', '7393854428', '7411074475', '7411242174',
    '7411827495', '7412050057', '7421062338', '7421458763', '7421876880', '7421879909', '7422121669', '7431204774',
    '7791628950', '8451019365', '8451043429', '8451064785', '8451282370', '8451321443', '8451925000', '8451981317',
    '8451987780', '8471112085', '8471611492', '8471613485', '8491024510', '8491173026', '6181080861', '6182148360',
    '6221627019', '6692465929', '6981598430', '6981780554', '7282202303', '7771496528', '7772930837', '7773238262',
    '7773308407', '7773374083', '7781158187', '7781419771', '7790053051', '7791600466', '7792233136', '7792439926',
    '7811344659', '7811805416', '7812007993', '7822092262', '7822196292', '7822210460', '7831581670', '7831603756',
    '7881717657', '9680997361', '9950048428', '9970054432', '4990606151', '5542642890', '5581758059', '5751040557',
    '5992839865', '6222784643', '6971033809', '6971988951', '6981570880', '6981578226', '7422098663', '7770021013',
    '7772292213', '7772513051', '7772567058', '7773055751', '7773265141', '7780116376', '7780170430', '7781081616',
    '7781336795', '7781372354', '7790041763', '7791106306', '7791228386', '7791289519', '7791308116', '7791332706',
    '7791507643', '7792083091', '7792145314', '7792196151', '7792287043', '7792342552', '7792384645', '7792410839',
    '7792413938', '7792525956', '7811087346', '7811252986', '7811280043', '7811352570', '7811617330', '7811621484',
    '7811696559', '7811772289', '7811820686', '7811876095', '7811885208', '7811918267', '7821248087', '7822330299',
    '7822865267', '7831007244', '7831071756', '7831108732', '7831283211', '7831519056', '7831586207', '7831751669',
    '7831763081', '7831768440', '7831774133', '7842388103', '8321717734', '9251900415', '9532431834', '9680977714',
    '9720148190', '9720934793', '9721051096', '9721147844', '9721204424', '9721305450', '6660003338', '6661945976',
    '7773234040', '7773264845', '7791157893', '7811641943', '7821653913', '7821987442', '7822550546', '7841386763',
    '7871174936', '7871183160', '9721236832', '6651217956', '6651653829', '6652936535', '6652988176', '6661368970',
    '6661769195', '6671009362', '6681972203', '7773239913', '7781132667', '7791228423', '7792083582', '7811374637',
    '7821082103', '7821117770', '7821429587', '7821710522', '7821725038', '7822107182', '7822176993', '7822452588',
    '7822573636', '7822634792', '7831682483', '7831748905', '7841224428', '7841483555', '7842377200', '7842424951',
    '7842487207', '7842524397', '7871370927', '7871415914', '7891248394', '7891471502', '7891471985', '7891713075',
    '9721288941', '5170003632', '5170011181', '5170014015', '5170119412', '5170273001', '7941164476', '7941496385',
    '7941557313', '8130268449', '8131267883', '8133273356', '8133746530', '8161183257', '8171068233', '8171852346',
    '8172146679', '8181198842', '8191466250', '8542373374', '8641578518', '8652420330', '8671045382', '8671338167',
    '8671928957', '8672088293', '8672236641', '8721162010', '8721228401', '8722186521', '5170210130', '5170304486',
    '5170312474', '5170357324', '5170378556', '5170383847', '7921064725', '7921180130', '7921822315', '7931609698',
    '7931626389', '7941639270', '7941753669', '7941774878', '7941819629', '7952115317', '8131195221', '8131202091',
    '8131286656', '8131420557', '8131444339', '8131750958', '8131751047', '8131800751', '8132292972', '8132899823',
    '8132901483', '8133161114', '8133273327', '8133476160', '8133476177', '8133513642', '8133616572', '8133672978',
    '8133677220', '8133696565', '8161077650', '8161412137', '8161526800', '8161700669', '8171016029', '8171033453',
    '8171852228', '8171860185', '8171885446', '8171987431', '8172091346', '8172186868', '8181103416', '8181463008',
    '8181717383', '8191538831', '8641577654', '8641922855', '8651667436', '8652577445', '8670010269', '8671197152',
    '8671576211', '8671693098', '8671875304', '8671882876', '8671883114', '8671918433', '8671976525', '8671994664',
    '8671997415', '8672138625', '8672237675', '8672238108', '8720008382', '8721085723', '8721116659', '8721244819',
    '8721363607', '8721398184', '8721888586', '8722237649', '8722259272', '1230710668', '1250994083', '1251615366',
    '5422004891', '5681495872', '7571116395', '7581040340', '7581540232', '7582344711', '7582347247', '7582352403',
    '7611064814', '7621677903', '1131529931', '1180348141', '1180871115', '1182112678', '1251534461', '1251557628',
    '5241758267', '5252006051', '5311280926', '5311488816', '5361014500', '5361048953', '5361066187', '5361141894',
    '5361192578', '5361763704', '5361807979', '5361914066', '5671027388', '5681149816', '5681399921', '5681443711',
    '7181682069', '7231110554', '7392237716', '7571007453', '7571061174', '7580000396', '7581027026', '7581034078',
    '7581045679', '7581050982', '7581052478', '7581059612', '7581074729', '7581257677', '7581454975', '7581525646',
    '7581755441', '7581888538', '7581958138', '7582029323', '7582109275', '7582262545', '7582374445', '7591736706',
    '7591743273', '7621023679', '7621036995', '7621116903', '7621313621', '7621322028', '7622008469', '9461232115',
    '9522051900', '1130005367', '1130088850', '1130209704', '1131079818', '1131146609', '1131528506', '1131853436',
    '1132185669', '1132371923', '1132393847', '1132452946', '1132726036', '1132733384', '1132777973', '1132884628',
    '1132913821', '1132974188', '5211801283', '5213504112', '5223042618', '5231581026', '5241243824', '5242148430',
    '5242644152', '5242893487', '5251575456', '5252100442', '5320003149', '5321050702', '5321079195', '5321085356',
    '5321239724', '5321366210', '5321664002', '5321713982', '5321726683', '5321961674', '5321975593', '5322027390',
    '5322028202', '5322047174', '5322048127', '5342312372', '5372202151', '5431118341', '6551689153', '6581232085',
    '6751209442', '7121017670', '7591226678', '7692211945', '8171056543', '8212107209', '8212560185', '8221331107',
    '8222247219', '8241726671', '8241791616', '8261037383', '8261211792', '8261364142', '8261819341', '8261835044',
    '8261919479', '8461601894', '8481081475', '8672123865', '9222366108', '9511291049', '9511761035', '9521028448',
    '9521454369', '9521992167', '9522132886', '9522182306', '9522210528', '5210417803', '1080016735', '1131966287',
    '1132463140', '1180373966', '1181406053', '1230969455', '1250086871', '5210410971', '5211075109', '5211632194',
    '5212770774', '5213042284', '5213212384', '5213275640', '5213304519', '5213478047', '5213588534', '5213625703',
    '5213656359', '5213694064', '5213702817', '5221019093', '5221234265', '5222302856', '5223078800', '5252383664',
    '5252528281', '5252601658', '5252739664', '5260303881', '5261047026', '5262574609', '5271715736', '5272692138',
    '5341975633', '5993101765', '7010311202', '7010341479', '7181974501', '7343260112', '7972011868', '8262014734',
    '8521417095', '8882460037', '9512043106', '9512312173', '9521328653', '9521790305', '9560006735', '1180089768',
    '1180091535', '5213708607', '5242893702', '5251577627', '5252264250', '5252799229', '5272777811', '6571205230',
    '8651772630', '1130196717', '1132877025', '1133014183', '1180045535', '1180057113', '1180123287', '1180746120',
    '1180758577', '1181737755', '1182118882', '1182135484', '1182192358', '1182201146', '5210002396', '5211233353',
    '5221491223', '5221718313', '5222181967', '5222249211', '5222874966', '5222923995', '5222954961', '5241299196',
    '5241602938', '5242377886', '5242634107', '5242764689', '5242777918', '5242900537', '5251334847', '5252750281',
    '5261123141', '5262108132', '5271510460', '5272317245', '5272342208', '5272386789', '5272930572', '5342269593',
    '5372066498', '5470206285', '5542125692', '5681457185', '5681487039', '5851466824', '5881758000', '6371807295',
    '6581780183', '7010413925', '7010420144', '7991899323', '8222118261', '8441715011', '9860174603', '5211307005',
    '5341014968', '6010080676', '7961196284', '7962274448', '7971221397', '7991741326', '9512401149', '1130916525',
    '1230054709', '1230063743', '1230488069', '1230886060', '1230917286', '1231416652', '5212113898', '5212206341',
    '5222595396', '5222953507', '5250009424', '5251559888', '5252700828', '5252795591', '5261214228', '5261511044',
    '5271055984', '5311092780', '5311495443', '5341031493', '5341238231', '5341699386', '5342489662', '5342588542',
    '5342594152', '5361192006', '5842025747', '6050006396', '6521378129', '7121918522', '7252132785', '7262676481',
    '7961622829', '7962418640', '7962766022', '7962953480', '7971018058', '7971018176', '7971030473', '7971109080',
    '7971258667', '7971574285', '7971637933', '7971729285', '7991893102', '8111702666', '8121448525', '8351219461',
    '9462227168', '9481095472', '9482218215', '9511133333', '9511203795', '9511989034', '9512185935', '9512194041',
    '9512336512', '9512395704', '9512431297', '9512460123', '9512476319', '5421797926', '5441536063', '7181895612',
    '7231078810', '7231529454', '8210008992', '8211047020', '8211471249', '8211562638', '8211646588', '8211997632',
    '8212065540', '8212563396', '5421123955', '5421749672', '5431015227', '5431366168', '5431369126', '5441009820',
    '5441013000', '5441030323', '5441092347', '5441407727', '5441432435', '5451535013', '5451617538', '7181115146',
    '7181195895', '7181458550', '7181911506', '7182025439', '7182073013', '7182148202', '7221167156', '7221460519',
    '8211026756', '8211048491', '8211050022', '8211068051', '8211569497', '8211569586', '8211759890', '8212068188',
    '8212391328', '8212650729', '8241163475', '8241810710', '8481052232', '8481550421', '8481848209', '8371646947',
    '8371669664', '9512333293', '1130124439', '5252690969', '8371010528', '8371054684', '8371058481', '8371174721',
    '8371217465', '8371258501', '8371544299', '8371545838', '8371597456', '8371693094', '8371787702', '8381131446',
    '8981203869', '9111664481', '6111045256', '6111047976', '6111053089', '6111213469', '6112654974', '6151471746',
    '6151765152', '6161451573', '6951448370', '8861010961', '8861092686', '8862501000', '8942709984', '8943036926',
    '8951750986', '8971895920', '8981556881', '8981793807', '8981974130', '8982184921', '8982214059', '8990000433',
    '8992352194', '8992446185', '8992749448', '9151734377', '6161441089', '6931359568', '9111008759', '9111940403',
    '9121755185', '9141262497', '9141404661', '9141562288', '9151194389', '9151194886', '9151523806', '9151793919',
    '9151820243', '9241739585', '9281731555', '5210121132', '5261057355', '5961250893', '6131544413', '6911288606',
    '6911324615', '6912503811', '6920001691', '6921055217', '6921766102', '6921988357', '6922254798', '6922265187',
    '6931011871', '6931034122', '6931135596', '6931242174', '6931360442', '6931487579', '6931552934', '6931599404',
    '6931625107', '6931634661', '6931991846', '6931992774', '6941266845', '6991368789', '7492032557', '8941930712',
    '8942633494', '8942686473', '8942981611', '8971340961', '8971667745', '8991322239', '8992228643', '8992858060',
    '8992859964', '9111119140', '9111762031', '9111870878', '9121650658', '9131600395', '9141069990', '9141105993',
    '9141201509', '9151040189', '9151200807', '9151557449', '9151681379', '9151789533', '9161078012', '9251034225',
    '9251723350', '9281059187', '9462580918', '9720927876', '9880095255'
]

SQL = """
    select pl.nip, pl.nazwa, pl.hs->'umowa' as umowa,
        case when pl.hs->'fakturyelektroniczne'='True' then 'T' else '' end as "E-faktury",
        sum(pf.kwotanetto) as "sprzedaż"
    from platnicy pl 
    left join faktury f on f.platnik=pl.id and not f.del 
    left join pozycjefaktur pf on pf.faktura=f.id and not pf.del 
    
    where pl.nip in %s and f.datasprzedazy between %s and %s 
    group by 1,2,3,4 order by 1,2,3
"""

# z faktur po dacie sprzedaży

LAUNCH_DIALOG = Dialog(title=MENU_ENTRY, panel=VBox(
    InfoText(text="Raport wykonywany dla stałej listy NIP, z wystawionych faktur"),
    DateInput(field='dataod', title='Data początkowa', default='PZM'),
    DateInput(field='datado', title='Data końcowa', default='KZM'),
))


def start_report(params):
    params = LAUNCH_DIALOG.load_params(params)
    report = TaskGroup(__PLUGIN__, params)
    validate_date_range(params['dataod'], params['datado'], 31)
    task = {
        'type': 'snr',
        'priority': 1,
        'params': params,
        'function': 'raport_snr'
    }
    report.create_task(task)
    report.save()
    return report


def raport_snr(task_params):
    params = task_params['params']
    snr = SNR()
    cols, rows = snr.select(SQL, [tuple(NIPY), params['dataod'], params['datado']])
    res = []
    byly_nipy = [row[0] for row in rows]
    for nip in NIPY:
        if nip not in byly_nipy:
            res.append({
                'type': 'warning', 'text': 'Nie znaleziono płatnika dla NIP %s' % nip,
            })
    res.append({
        'type': 'table',
        'header': cols,
        'data': prepare_for_json(rows)
    })
    return res